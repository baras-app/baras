---
phase: 13-editor-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/src/components/encounter_editor/timers.rs
  - app/src/components/combat_log.rs
autonomous: true

must_haves:
  truths:
    - "User does not see raw file path in Encounter Builder timer form"
    - "User selects different encounter and combat log table resets to top"
  artifacts:
    - path: "app/src/components/encounter_editor/timers.rs"
      provides: "Timer form without file path display"
    - path: "app/src/components/combat_log.rs"
      provides: "Combat log with scroll reset on encounter change"
      contains: "scroll_top.set(0.0)"
  key_links:
    - from: "app/src/components/combat_log.rs"
      to: "scroll_top signal"
      via: "use_effect on encounter_idx change"
      pattern: "props.encounter_idx"
---

<objective>
Remove raw file path from Encounter Builder and fix combat log scroll reset on encounter selection.

Purpose: Clean up UI noise (file path is implementation detail users don't need) and fix scroll behavior that confuses users when switching encounters.

Output: Cleaner Encounter Builder UI and proper scroll reset behavior in Combat Log.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-editor-polish/13-CONTEXT.md
@.planning/phases/13-editor-polish/13-RESEARCH.md
@app/src/components/encounter_editor/timers.rs
@app/src/components/combat_log.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove file path display from Encounter Builder</name>
  <files>app/src/components/encounter_editor/timers.rs</files>
  <action>
Remove the file path display at line 878 in TimerEditForm.

Find and delete this line:
```rust
div { class: "mt-sm text-xs text-muted", "File: {boss_with_path.file_path}" }
```

This line is around line 877-878, just before the closing brace of the TimerEditForm component. Simply delete the entire `div { class: "mt-sm text-xs text-muted", "File: {boss_with_path.file_path}" }` line.

The file path is an implementation detail that users don't need to see. Per CONTEXT.md: "Raw file path removed from Encounter Builder entirely (just remove it, no replacement)".
  </action>
  <verify>grep -n "file_path" app/src/components/encounter_editor/timers.rs shows no display of file_path in UI (may still have the field access for save operations)</verify>
  <done>Encounter Builder timer form no longer displays the raw file path to users</done>
</task>

<task type="auto">
  <name>Task 2: Fix combat log scroll reset on encounter change</name>
  <files>app/src/components/combat_log.rs</files>
  <action>
The combat log already resets scroll on filter changes (line 147-149), but the encounter_idx is passed as a prop and the scroll reset needs to also happen when the encounter changes (not just filters).

The issue: The component uses `props.encounter_idx` directly in the `use_effect` at line 134, but the scroll reset at lines 147-148 is inside that same effect which is triggered by filter signal changes. When encounter changes, props change but the existing signals (source_filter, target_filter, etc.) don't change, so scroll doesn't reset.

**Solution:** Add a separate `use_effect` that watches encounter_idx changes specifically and resets scroll. Add this BEFORE the existing data-loading use_effect (around line 132):

```rust
// Reset scroll when encounter changes
use_effect({
    let encounter_idx = props.encounter_idx;
    move || {
        // This effect runs when encounter_idx prop changes
        let _ = encounter_idx; // Capture for reactivity
        scroll_top.set(0.0);
        loaded_offset.set(0);
    }
});
```

Wait - actually looking more carefully, the existing `use_effect` at line 134 IS triggered when encounter_idx changes because it reads `props.encounter_idx` (via `let idx = props.encounter_idx;`). However, the scroll reset IS inside the spawn block which runs async.

Actually re-reading the code: the use_effect at line 134 does read `let idx = props.encounter_idx;` so it SHOULD trigger when encounter changes. And lines 147-148 DO reset scroll inside the spawn. Let me verify the issue isn't something else.

The problem may be: `props.encounter_idx` isn't being tracked as a dependency because it's read outside the effect body. In Dioxus, the effect tracks signals read INSIDE the closure.

**Better solution:** The encounter_idx is passed through props, not as a signal. The existing pattern mirrors it into `time_range_signal` (line 92-97) to make it reactive. We need similar handling.

Add a mirror signal for encounter_idx and use that to trigger scroll resets:

After line 92 (the time_range_signal initialization), add:
```rust
// Mirror encounter_idx prop into a signal for reactivity
let mut encounter_idx_signal = use_signal(|| props.encounter_idx);

// Update signal when props change
if *encounter_idx_signal.read() != props.encounter_idx {
    encounter_idx_signal.set(props.encounter_idx);
    // Reset scroll immediately when encounter changes
    scroll_top.set(0.0);
    loaded_offset.set(0);
}
```

Then update the use_effect at line 134 to use `encounter_idx_signal` instead of `props.encounter_idx`:
```rust
use_effect(move || {
    let idx = *encounter_idx_signal.read(); // Now reads from signal
    // ... rest of effect unchanged
});
```

Also update the scroll loading use_effect around line 212 to use `encounter_idx_signal.read()` instead of `props.encounter_idx`.

Wait, that's more complex than needed. Let me look at the simpler approach.

Actually, the simplest fix: The existing code at lines 95-97 already does prop-to-signal mirroring for time_range. The scroll reset at line 147-148 happens INSIDE the async spawn, so it happens AFTER the comparison. The fix is to reset scroll in the synchronous part of the effect, not just inside the spawn.

**Final solution:** Move the scroll reset to happen synchronously when filters change, not just inside the async spawn. Modify the use_effect starting at line 134:

Change from:
```rust
use_effect(move || {
    let idx = props.encounter_idx;
    let tr = time_range_signal.read().clone();
    // ... other signal reads ...

    spawn(async move {
        // Reset scroll position
        scroll_top.set(0.0);
        loaded_offset.set(0);
        // ... data loading ...
    });
});
```

To:
```rust
use_effect(move || {
    let idx = props.encounter_idx;
    let tr = time_range_signal.read().clone();
    // ... other signal reads ...

    // Reset scroll position synchronously before async load
    scroll_top.set(0.0);
    loaded_offset.set(0);

    spawn(async move {
        // ... data loading (remove the scroll reset from here) ...
    });
});
```

This ensures scroll resets immediately when any dependency changes (including the encounter_idx via props), rather than only after the async spawn starts.
  </action>
  <verify>
1. grep -n "scroll_top.set(0.0)" app/src/components/combat_log.rs shows the reset happens outside the spawn block in the main use_effect
2. cargo check -p baras-app compiles without errors
  </verify>
  <done>Combat log resets scroll position to top when a new encounter is selected</done>
</task>

</tasks>

<verification>
1. `cargo check -p baras-app` compiles without errors
2. `grep -n "file_path" app/src/components/encounter_editor/timers.rs` shows no UI display of file_path
3. Scroll reset logic executes synchronously in the use_effect (not just inside spawn)
</verification>

<success_criteria>
1. Both files compile without errors
2. Encounter Builder timer form does not display raw file path (EDIT-06 complete)
3. Combat log resets scroll to top when user selects different encounter (DATA-01 complete)
</success_criteria>

<output>
After completion, create `.planning/phases/13-editor-polish/13-02-SUMMARY.md`
</output>
