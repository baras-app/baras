---
phase: 15-objc2-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - overlay/Cargo.toml
  - overlay/src/platform/macos.rs
autonomous: true

must_haves:
  truths:
    - "objc2 ecosystem dependencies added to Cargo.toml"
    - "Foundation types use objc2_foundation (NSRect, NSPoint, NSSize)"
    - "msg_send! syntax updated to objc2 comma-separated arguments"
  artifacts:
    - path: "overlay/Cargo.toml"
      provides: "objc2 dependencies with feature flags"
      contains: "objc2-app-kit"
    - path: "overlay/src/platform/macos.rs"
      provides: "Updated imports and msg_send! calls"
      contains: "use objc2"
  key_links:
    - from: "overlay/Cargo.toml"
      to: "overlay/src/platform/macos.rs"
      via: "crate imports"
      pattern: "objc2"
---

<objective>
Add objc2 ecosystem dependencies and migrate msg_send! calls to objc2 syntax.

Purpose: Establish foundation for full objc2 migration. The objc2 crate provides safer, more ergonomic Objective-C bindings compared to deprecated `objc` crate.

Output: Cargo.toml with new dependencies, updated imports, and all msg_send! calls using objc2 syntax.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/STACK.md
@.planning/research/PITFALLS.md
@overlay/Cargo.toml
@overlay/src/platform/macos.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add objc2 dependencies to Cargo.toml</name>
  <files>overlay/Cargo.toml</files>
  <action>
Update the macOS dependencies section to add objc2 ecosystem crates alongside existing crates (keep cocoa and objc temporarily for gradual migration):

```toml
# Platform: macOS
[target.'cfg(target_os = "macos")'.dependencies]
# Deprecated - will be removed in Phase 16
cocoa = "0.26"
objc = "0.2"
# Keep core-graphics for CGContext operations
core-graphics = "0.24"

# New objc2 ecosystem
objc2 = "0.6"
objc2-foundation = { version = "0.3", default-features = false, features = [
    "NSArray",
    "NSDate",
    "NSGeometry",
    "NSObject",
    "NSString",
] }
objc2-app-kit = { version = "0.3", default-features = false, features = [
    "NSApplication",
    "NSColor",
    "NSEvent",
    "NSGraphicsContext",
    "NSResponder",
    "NSRunningApplication",
    "NSScreen",
    "NSView",
    "NSWindow",
] }
```

Note: Using default-features = false with explicit features for minimal compile time. The NSGeometry feature provides NSRect, NSPoint, NSSize.
  </action>
  <verify>
Run `cargo check -p baras-overlay --target aarch64-apple-darwin` to verify dependencies resolve and features are correct. If no macOS target available, `cargo metadata` should show resolved dependencies.
  </verify>
  <done>
Cargo.toml contains objc2, objc2-foundation, and objc2-app-kit with appropriate feature flags.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update imports and migrate msg_send! calls</name>
  <files>overlay/src/platform/macos.rs</files>
  <action>
Update the imports at the top of the file. Keep both old and new imports temporarily during migration:

```rust
//! macOS platform implementation for overlay windows
//!
//! Uses Cocoa/AppKit for transparent, always-on-top overlay windows
//! with click-through support.

use std::ffi::c_void;

// Keep cocoa imports for now (will be removed in Plan 15-03)
use cocoa::appkit::{
    NSApp, NSApplication, NSApplicationActivationPolicyAccessory, NSBackingStoreBuffered,
    NSColor, NSEvent, NSEventMask, NSEventType, NSScreen, NSView, NSWindow,
    NSWindowCollectionBehavior, NSWindowStyleMask,
};
use cocoa::base::{id, nil, NO, YES};
use cocoa::foundation::{NSArray, NSDate, NSString};

// New objc2 foundation types (replace cocoa::foundation geometry)
use objc2_foundation::{NSPoint, NSRect, NSSize};

// Keep core-graphics
use core_graphics::base::kCGImageAlphaPremultipliedFirst;
use core_graphics::color_space::CGColorSpace;
use core_graphics::context::CGContext;

// Keep old objc for ClassDecl (will be migrated in Plan 15-02)
use objc::declare::ClassDecl;
use objc::runtime::{Class, Object, Sel, BOOL};

// New objc2 for msg_send! - use both during transition
use objc2::{class, msg_send, sel};
```

Then update ALL msg_send! calls to use the new comma-separated syntax. Key changes:

1. **Arguments separated by commas** (not colons between args):
   - Old: `msg_send![obj, setFrame:rect display:YES]`
   - New: `msg_send![obj, setFrame: rect, display: true]`

2. **Use Rust bool instead of YES/NO for objc2**:
   - Old: `msg_send![view, setNeedsDisplay: YES]`
   - New: `msg_send![view, setNeedsDisplay: true]`

3. **Keep explicit return type annotations**:
   - `let result: () = msg_send![...]`
   - `let screen: id = msg_send![...]`

Update these specific msg_send! calls in macos.rs:

Line 38 (get_all_monitors):
```rust
let screen: id = msg_send![screens, objectAtIndex: i];
```

Line 40-41:
```rust
let name: id = msg_send![screen, localizedName];
```

Line 65:
```rust
let cstr: *const i8 = msg_send![nsstring, UTF8String];
```

Line 105 (draw_rect):
```rust
let bounds: NSRect = msg_send![this, bounds];
```

Line 122-124:
```rust
let ns_ctx: id = msg_send![class!(NSGraphicsContext), currentContext];
// ...
let cg_ctx_ptr: *mut c_void = msg_send![ns_ctx, CGContext];
```

Line 281-282:
```rust
let view: id = msg_send![view_class, alloc];
let view: id = msg_send![view, initWithFrame: rect];
```

Line 392:
```rust
let _: () = msg_send![self.view, setFrame: view_rect];
```

Line 463:
```rust
let _: () = msg_send![self.view, setNeedsDisplay: true];  // Changed from YES
```

Line 471-477 (poll_events):
```rust
let event: id = msg_send![
    NSApp(),
    nextEventMatchingMask: NSEventMask::NSAnyEventMask,
    untilDate: nil,
    inMode: NSString::alloc(nil).init_str("kCFRunLoopDefaultMode"),
    dequeue: true  // Changed from YES
];
```

Line 487:
```rust
let event_window: id = msg_send![event, window];
```

Line 565:
```rust
let _: () = msg_send![NSApp(), sendEvent: event];
```

Important: The objc2 msg_send! macro uses commas between arguments where the old objc crate used colons. This is a syntax change, not a semantic one.
  </action>
  <verify>
Run `cargo check -p baras-overlay --target aarch64-apple-darwin` to verify the code compiles with updated msg_send! syntax.
  </verify>
  <done>
All msg_send! calls use objc2 comma-separated syntax, imports include objc2 crates, and code compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. `cargo check -p baras-overlay --target aarch64-apple-darwin` passes
2. Cargo.toml contains objc2, objc2-foundation, objc2-app-kit dependencies
3. macos.rs imports objc2 crates
4. All msg_send! calls use comma-separated arguments
5. No YES/NO literals remain in msg_send! calls (use true/false)
</verification>

<success_criteria>
- objc2 dependencies added with correct features
- All msg_send! calls migrated to objc2 syntax
- Code compiles for macOS target
- Requirements MAC-02 partially satisfied (foundation types ready)
</success_criteria>

<output>
After completion, create `.planning/phases/15-objc2-migration/15-01-SUMMARY.md`
</output>
