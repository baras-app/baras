---
phase: 14-cgcontext-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - overlay/src/platform/macos.rs
autonomous: true

must_haves:
  truths:
    - "macOS overlay crate compiles for aarch64-apple-darwin target"
    - "CGContext bitmap rendering uses correct core-graphics API"
  artifacts:
    - path: "overlay/src/platform/macos.rs"
      provides: "Fixed draw_rect function with correct CGContext API usage"
      contains: "CGContext::from_existing_context_ptr"
  key_links:
    - from: "draw_rect function"
      to: "core-graphics::context::CGContext"
      via: "create_bitmap_context and from_existing_context_ptr"
      pattern: "CGContext::create_bitmap_context|CGContext::from_existing_context_ptr"
---

<objective>
Fix CGContext compilation errors in macOS overlay platform code.

Purpose: Unblock macOS builds by correcting API misuse of the core-graphics crate.
Output: Compilable macOS overlay code with correct CGContext bitmap rendering.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/ARCHITECTURE.md (CGContext Fix section, lines 284-447)
@overlay/src/platform/macos.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix draw_rect CGContext API calls</name>
  <files>overlay/src/platform/macos.rs</files>
  <action>
Fix three CGContext API issues in the draw_rect function (lines 95-145):

**Issue 1 (Line 110): Parameter type**
The `pixel_ptr` is already `*mut c_void` from the ivar. Remove the `as *mut u8` cast:
```rust
// Before:
Some(pixel_ptr as *mut u8),
// After:
Some(pixel_ptr),
```

**Issue 2 (Lines 117-121): Return type handling**
`CGContext::create_bitmap_context` returns `CGContext` directly, not `Option<CGContext>`.
Remove the `if let Some(ctx) = ctx` unwrapping pattern:
```rust
// Before:
if let Some(ctx) = ctx {
    let image = ctx.create_image();
    if let Some(image) = image {
// After:
if let Some(image) = ctx.create_image() {
```

**Issue 3 (Lines 127-130): Correct method name and type**
The method is on `CGContext`, not `CGContextRef`. Use correct import and cast:
```rust
// Before:
let cg_ctx = core_graphics::context::CGContextRef::from_existing_context_ptr(
    cg_ctx,
);
// After:
let cg_ctx = CGContext::from_existing_context_ptr(
    cg_ctx_ptr as *mut core_graphics::sys::CGContext
);
```

Ensure the import `use core_graphics::context::CGContext;` is present (line 17 already has it).

The complete fixed draw_rect function should be:
```rust
extern "C" fn draw_rect(this: &Object, _sel: Sel, _dirty_rect: NSRect) {
    unsafe {
        let pixel_ptr: *mut c_void = *this.get_ivar("pixelData");
        let width: u32 = *this.get_ivar("bufferWidth");
        let height: u32 = *this.get_ivar("bufferHeight");

        if pixel_ptr.is_null() || width == 0 || height == 0 {
            return;
        }

        let bounds: NSRect = msg_send![this, bounds];
        let color_space = CGColorSpace::create_device_rgb();

        // Create CGContext from our pixel buffer (BGRA format)
        let ctx = CGContext::create_bitmap_context(
            Some(pixel_ptr),  // Already *mut c_void, no cast needed
            width as usize,
            height as usize,
            8,
            (width * 4) as usize,
            &color_space,
            kCGImageAlphaPremultipliedFirst, // BGRA
        );

        // create_image returns Option<CGImage>
        if let Some(image) = ctx.create_image() {
            // Get current graphics context
            let ns_ctx: id = msg_send![class!(NSGraphicsContext), currentContext];
            if ns_ctx != nil {
                let cg_ctx_ptr: *mut c_void = msg_send![ns_ctx, CGContext];

                if !cg_ctx_ptr.is_null() {
                    let cg_ctx = CGContext::from_existing_context_ptr(
                        cg_ctx_ptr as *mut core_graphics::sys::CGContext
                    );

                    cg_ctx.draw_image(
                        core_graphics::geometry::CGRect::new(
                            &core_graphics::geometry::CGPoint::new(0.0, 0.0),
                            &core_graphics::geometry::CGSize::new(
                                bounds.size.width,
                                bounds.size.height,
                            ),
                        ),
                        &image,
                    );
                }
            }
        }
    }
}
```
  </action>
  <verify>
Run `cargo check -p baras-overlay` to verify compilation (will fail on Linux but should show no CGContext-related errors if syntax is correct).
Alternatively, search for the specific patterns to confirm changes:
- `grep "Some(pixel_ptr)" overlay/src/platform/macos.rs` should show no `as *mut u8`
- `grep "if let Some(ctx) = ctx" overlay/src/platform/macos.rs` should return nothing
- `grep "CGContextRef::from_existing_context_ptr" overlay/src/platform/macos.rs` should return nothing
- `grep "CGContext::from_existing_context_ptr" overlay/src/platform/macos.rs` should return a match
  </verify>
  <done>
draw_rect function uses correct core-graphics API:
1. create_bitmap_context receives *mut c_void directly (no cast to *mut u8)
2. No Option unwrapping on create_bitmap_context result (it returns CGContext directly)
3. from_existing_context_ptr called on CGContext with correct pointer type
  </done>
</task>

</tasks>

<verification>
1. Code patterns match expected fixes (grep verification)
2. No references to `CGContextRef::from_existing_context_ptr` remain
3. No `if let Some(ctx) = ctx` pattern on bitmap context result
4. File compiles without CGContext-related type errors

Note: Full cross-compilation test requires macOS target toolchain which may not be available.
Alternative verification: Manual code review confirms API usage matches core-graphics 0.24 documentation.
</verification>

<success_criteria>
- [ ] draw_rect function uses `Some(pixel_ptr)` without `as *mut u8` cast
- [ ] create_bitmap_context result used directly (no Option unwrap)
- [ ] `CGContext::from_existing_context_ptr` used with correct type cast
- [ ] Code compiles on Linux (cfg-gated, no syntax errors in macOS code)
</success_criteria>

<output>
After completion, create `.planning/phases/14-cgcontext-fix/14-01-SUMMARY.md`
</output>
