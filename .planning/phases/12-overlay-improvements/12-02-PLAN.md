---
phase: 12-overlay-improvements
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/src/components/settings_panel.rs
  - app/assets/styles.css
  - app/src-tauri/src/commands/overlay.rs
autonomous: true

must_haves:
  truths:
    - "Save button is visible without scrolling when settings panel is open"
    - "Changes preview live in overlays before user clicks Save (300ms debounce)"
    - "Canceling or navigating away restores original overlay appearance"
    - "Save button appearance changes when there are unsaved changes"
  artifacts:
    - path: "app/src/components/settings_panel.rs"
      provides: "Debounced preview logic and restructured panel"
      contains: "preview_overlay_settings"
    - path: "app/assets/styles.css"
      provides: "Fixed footer and unsaved styling"
      contains: "settings-footer"
    - path: "app/src-tauri/src/commands/overlay.rs"
      provides: "Preview command (no persist)"
      exports: ["preview_overlay_settings"]
  key_links:
    - from: "settings_panel.rs"
      to: "api::preview_overlay_settings"
      via: "debounced 300ms call"
      pattern: "Timeout::new.*300"
    - from: "preview_overlay_settings command"
      to: "OverlayManager::create_config_update"
      via: "sends config without persisting"
      pattern: "create_config_update"
---

<objective>
Make settings panel save button always visible and preview changes live in overlays before saving.

Purpose: Users currently must scroll to find the save button, and can't see the effect of changes until after saving. Live preview with a visible save button improves the customization workflow.
Output: Restructured settings panel with fixed footer and debounced preview functionality.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-overlay-improvements/12-CONTEXT.md
@.planning/phases/12-overlay-improvements/12-RESEARCH.md

@app/src/components/settings_panel.rs
@app/assets/styles.css
@app/src-tauri/src/commands/overlay.rs
@app/src/api.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add preview command to backend</name>
  <files>app/src-tauri/src/commands/overlay.rs</files>
  <action>
Add a new Tauri command that sends overlay config updates WITHOUT persisting to disk.

1. Add the command (near other overlay commands):
   ```rust
   /// Preview overlay settings without persisting to disk.
   /// Used for live preview while user is editing settings.
   #[tauri::command]
   pub async fn preview_overlay_settings(
       settings: OverlaySettings,
       overlay_state: State<'_, SharedOverlayState>,
   ) -> Result<bool, String> {
       let overlays: Vec<_> = {
           let s = overlay_state.lock().map_err(|e| e.to_string())?;
           s.all_overlays()
               .into_iter()
               .map(|(k, tx)| (k, tx.clone()))
               .collect()
       };

       for (kind, tx) in overlays {
           let config_update = OverlayManager::create_config_update(kind, &settings);
           let _ = tx.send(OverlayCommand::UpdateConfig(config_update)).await;
       }

       Ok(true)
   }
   ```

2. Ensure imports include `OverlaySettings` from `baras_core::context`.

3. Register the command in `lib.rs` invoke_handler (add to the overlay commands section around line 165):
   ```rust
   commands::preview_overlay_settings,
   ```
  </action>
  <verify>
Build succeeds: `cargo build -p baras-app`
Command registered: grep for "preview_overlay_settings" in lib.rs
  </verify>
  <done>
Backend can preview overlay settings without persisting to disk.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add frontend API and implement debounced preview</name>
  <files>app/src/components/settings_panel.rs, app/src/api.rs</files>
  <action>
Add the frontend API call and implement debounced preview in settings panel.

**In app/src/api.rs:**

Add the API function (near other overlay functions):
```rust
pub async fn preview_overlay_settings(settings: &OverlaySettings) -> bool {
    invoke::<_, bool>("preview_overlay_settings", &PreviewSettingsArgs { settings: settings.clone() })
        .await
        .unwrap_or(false)
}

#[derive(Serialize)]
struct PreviewSettingsArgs {
    settings: OverlaySettings,
}
```

**In app/src/components/settings_panel.rs:**

1. Add import at top:
   ```rust
   use gloo_timers::callback::Timeout;
   ```

2. Add debounce handle signal near other signals (around line 35):
   ```rust
   let mut preview_timeout: Signal<Option<Timeout>> = use_signal(|| None);
   ```

3. Create a helper closure for debounced preview (after the signals, before the render):
   ```rust
   let trigger_preview = {
       let draft_settings = draft_settings.clone();
       move || {
           // Cancel any pending preview
           if let Some(handle) = preview_timeout.take() {
               handle.cancel();
           }

           let settings_clone = draft_settings();
           let timeout = Timeout::new(300, move || {
               spawn(async move {
                   api::preview_overlay_settings(&settings_clone).await;
               });
           });
           preview_timeout.set(Some(timeout));
       }
   };
   ```

4. Modify the update pattern throughout the component. Anywhere `draft_settings.set(...)` and `has_changes.set(true)` are called together, add `trigger_preview()` call.

   Example - in color change handlers:
   ```rust
   // Before:
   draft_settings.set(d);
   has_changes.set(true);

   // After:
   draft_settings.set(d);
   has_changes.set(true);
   trigger_preview();
   ```

5. On cancel (close without save), restore original settings to overlays:
   Find the close button handler and add:
   ```rust
   onclick: move |_| {
       // Cancel any pending preview
       if let Some(handle) = preview_timeout.take() {
           handle.cancel();
       }
       // Restore original settings if there were changes
       if has_changes() {
           spawn(async move {
               api::refresh_overlay_settings().await;
           });
       }
       on_close.call(());
   }
   ```

Note: The file is large. Focus on the pattern - search for `has_changes.set(true)` to find all places needing the preview trigger.
  </action>
  <verify>
Build succeeds: `cargo build -p baras-app`
Frontend build succeeds: `cd app && dx build`
  </verify>
  <done>
Settings changes trigger debounced preview updates to overlays. Cancel restores original appearance.
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix save button position and add unsaved styling</name>
  <files>app/src/components/settings_panel.rs, app/assets/styles.css</files>
  <action>
Restructure settings panel for fixed footer and add visual indication of unsaved changes.

**In app/assets/styles.css:**

1. Update `.settings-panel` to use flex layout with constrained height:
   ```css
   .settings-panel {
     position: relative;
     width: 90%;
     max-width: 750px;
     max-height: 85vh;
     background: var(--gradient-panel);
     border-radius: 0.5em;
     padding: 1.5em;
     box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
     display: flex;
     flex-direction: column;
     border: 1px solid var(--blue-alpha-20);
   }
   ```

2. Add scrollable content wrapper style:
   ```css
   .settings-content {
     flex: 1;
     overflow-y: auto;
     min-height: 0; /* Required for flex overflow */
   }
   ```

3. Update `.settings-footer` for sticky positioning:
   ```css
   .settings-footer {
     display: flex;
     align-items: center;
     gap: 1em;
     margin-top: 1em;
     padding-top: 1em;
     border-top: 1px solid var(--blue-alpha-15);
     flex-shrink: 0;
     background: inherit;
   }
   ```

4. Add unsaved changes styling:
   ```css
   .btn-save.btn-unsaved {
     background: linear-gradient(180deg,
         rgba(180, 140, 50, 0.3) 0%,
         rgba(140, 100, 30, 0.4) 100%);
     border-color: rgba(200, 160, 60, 0.6);
     animation: pulse-subtle 2s ease-in-out infinite;
   }

   .btn-save.btn-unsaved:hover {
     background: linear-gradient(180deg,
         rgba(200, 160, 60, 0.4) 0%,
         rgba(160, 120, 40, 0.5) 100%);
     border-color: rgba(220, 180, 80, 0.8);
   }

   @keyframes pulse-subtle {
     0%, 100% { opacity: 1; }
     50% { opacity: 0.85; }
   }
   ```

**In app/src/components/settings_panel.rs:**

1. Wrap the scrollable content (tabs, tab content, etc.) in a div with class "settings-content". The structure should be:
   ```rust
   section { class: "settings-panel floating", ...
       // Header (stays outside scrollable area)
       div { class: "settings-header draggable", ... }

       // Profiles collapsible (stays outside? or inside - use judgment)

       // Scrollable content wrapper
       div { class: "settings-content",
           // Tabs
           div { class: "settings-tabs", ... }

           // Tab content
           if tab == "personal" { ... }
           // ... all other tab content ...
       }

       // Footer (stays outside scrollable area)
       div { class: "settings-footer", ... }
   }
   ```

2. Update save button class to indicate unsaved state:
   ```rust
   button {
       class: if has_changes() { "btn btn-save btn-unsaved" } else { "btn btn-save" },
       disabled: !has_changes(),
       onclick: save_handler,
       if has_changes() { "Save Changes *" } else { "Save" }
   }
   ```
  </action>
  <verify>
Build succeeds: `cargo build -p baras-app`
CSS valid: No syntax errors
Manual: Settings panel footer stays visible when scrolling content
  </verify>
  <done>
Save button always visible without scrolling. Save button visually indicates unsaved changes.
  </done>
</task>

</tasks>

<verification>
1. Build passes: `cargo build -p baras-app`
2. Frontend builds: `cd app && dx build`
3. No clippy warnings: `cargo clippy -p baras-app -- -D warnings`
4. Visual check: Save button visible at bottom of settings panel without scrolling
5. Preview works: Changing a setting updates overlay appearance within ~300ms
</verification>

<success_criteria>
- OVLY-02 satisfied: Save button visible without scrolling
- OVLY-03 satisfied: Changes preview live with 300ms debounce, cancel restores original
- Save button appearance changes when unsaved changes exist
- Build passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-overlay-improvements/12-02-SUMMARY.md`
</output>
