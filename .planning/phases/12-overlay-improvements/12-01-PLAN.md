---
phase: 12-overlay-improvements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/src-tauri/src/overlay/manager.rs
  - app/src-tauri/src/commands/service.rs
autonomous: true

must_haves:
  truths:
    - "Move mode is false when app starts (never persists from previous session)"
    - "Move mode resets to false when user switches profile"
    - "Overlays show last encounter data on startup (not blank)"
  artifacts:
    - path: "app/src-tauri/src/overlay/manager.rs"
      provides: "Startup data display from cache"
      contains: "current_combat_data"
    - path: "app/src-tauri/src/commands/service.rs"
      provides: "Profile switch move mode reset"
      contains: "move_mode = false"
  key_links:
    - from: "OverlayManager::show_all"
      to: "service.current_combat_data()"
      via: "removes is_tailing gate"
      pattern: "current_combat_data.*await"
    - from: "load_profile command"
      to: "overlay_state.move_mode"
      via: "reset on switch"
      pattern: "move_mode.*false"
---

<objective>
Fix overlay startup behavior: ensure move mode resets on app startup and profile switch, and overlays display cached encounter data on startup instead of appearing blank.

Purpose: Users currently see blank overlays on startup even when session data exists. Move mode should never persist across sessions.
Output: Backend changes to overlay initialization and profile switching logic.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-overlay-improvements/12-CONTEXT.md
@.planning/phases/12-overlay-improvements/12-RESEARCH.md

@app/src-tauri/src/overlay/manager.rs
@app/src-tauri/src/overlay/state.rs
@app/src-tauri/src/commands/service.rs
@app/src-tauri/src/lib.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove is_tailing gate for startup data</name>
  <files>app/src-tauri/src/overlay/manager.rs</files>
  <action>
In `OverlayManager::show()` (around line 392) and `OverlayManager::show_all()` (around line 460), the code gates initial data sending on `service.is_tailing().await`. This prevents overlays from showing cached encounter data on fresh startup.

Modify both methods to always attempt to get cached data regardless of tailing state:

1. In `show()`: Replace `if service.is_tailing().await { ... }` block with unconditional call:
   ```rust
   // Send initial data from cache if available
   let combat_data = service.current_combat_data().await;
   Self::send_initial_data(kind, &tx, combat_data.as_ref()).await;
   ```

2. In `show_all()`: Same change - replace the conditional block (lines 460-464):
   ```rust
   // Get combat data once for all overlays (always try, regardless of tailing)
   let combat_data = service.current_combat_data().await;
   ```

The `send_initial_data` method already handles None gracefully (returns early if no data).
  </action>
  <verify>
Build succeeds: `cargo build -p baras-app`
Code review: grep for `is_tailing` in manager.rs should not appear in show/show_all context
  </verify>
  <done>
Overlays receive cached encounter data on startup regardless of whether file tailing is active.
  </done>
</task>

<task type="auto">
  <name>Task 2: Reset move mode on profile switch</name>
  <files>app/src-tauri/src/commands/service.rs</files>
  <action>
In the `load_profile` command (around line 213), add logic to reset move mode when switching profiles.

1. Add the overlay state to the command signature:
   ```rust
   #[tauri::command]
   pub async fn load_profile(
       name: String,
       handle: State<'_, ServiceHandle>,
       overlay_state: State<'_, SharedOverlayState>,
   ) -> Result<(), String> {
   ```

2. After loading the profile config, reset move mode:
   ```rust
   // Reset move mode on profile switch
   if let Ok(mut state) = overlay_state.lock() {
       state.move_mode = false;
       state.rearrange_mode = false;
   }
   ```

3. Broadcast the reset to all running overlays:
   ```rust
   // Broadcast move mode reset to all overlays
   let txs: Vec<_> = {
       if let Ok(s) = overlay_state.lock() {
           s.all_txs().into_iter().cloned().collect()
       } else {
           vec![]
       }
   };
   for tx in txs {
       let _ = tx.send(OverlayCommand::SetMoveMode(false)).await;
   }
   ```

4. Add necessary imports at top of file:
   ```rust
   use crate::overlay::{OverlayCommand, SharedOverlayState};
   ```

Note: The existing `OverlayState::default()` already initializes `move_mode: false`, so app startup is already correct. This change adds the profile switch reset per CONTEXT.md.
  </action>
  <verify>
Build succeeds: `cargo build -p baras-app`
Code review: `load_profile` now takes `overlay_state` parameter and resets `move_mode`
  </verify>
  <done>
Move mode resets to false when user switches overlay profiles.
  </done>
</task>

</tasks>

<verification>
1. Build passes: `cargo build -p baras-app`
2. No clippy warnings in modified files: `cargo clippy -p baras-app -- -D warnings`
3. Manual verification (if possible): Start app, overlays should show last encounter data if available
</verification>

<success_criteria>
- OVLY-01 satisfied: Move mode is false on startup (existing) and resets on profile switch (new)
- EMPTY-02 satisfied: Overlays display cached encounter data on startup (not gated by is_tailing)
- Build passes with no errors
- No new warnings introduced
</success_criteria>

<output>
After completion, create `.planning/phases/12-overlay-improvements/12-01-SUMMARY.md`
</output>
