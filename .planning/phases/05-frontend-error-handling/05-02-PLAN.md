---
phase: 05-frontend-error-handling
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/src/utils.rs
  - app/src/api.rs
autonomous: true

must_haves:
  truths:
    - "JS Reflect::set calls do not panic"
    - "JS interop failures are logged to console"
    - "API argument building uses fallible helper"
  artifacts:
    - path: "app/src/utils.rs"
      provides: "JS interop helper function"
      exports: ["js_set"]
    - path: "app/src/api.rs"
      provides: "API wrappers with safe JS interop"
      contains: "js_set"
  key_links:
    - from: "app/src/api.rs"
      to: "app/src/utils.rs"
      via: "crate::utils::js_set import"
      pattern: "use crate::utils::js_set"
---

<objective>
Create JS interop helper and eliminate all js_sys::Reflect::set().unwrap() calls in api.rs.

Purpose: Removes ~60 potential panic points in the API layer. JS Reflect::set can fail with frozen objects or invalid keys - currently these would panic the WASM module.

Output: Safe js_set helper function and api.rs with zero Reflect::set unwraps.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-frontend-error-handling/05-CONTEXT.md
@.planning/phases/05-frontend-error-handling/05-RESEARCH.md
@app/src/utils.rs
@app/src/api.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create js_set helper function</name>
  <files>app/src/utils.rs</files>
  <action>
Add to `app/src/utils.rs`:

```rust
use wasm_bindgen::JsValue;

/// Set a property on a JS object. Logs error and continues on failure.
/// Use this instead of js_sys::Reflect::set().unwrap() to prevent panics.
pub fn js_set(obj: &JsValue, key: &str, value: &JsValue) {
    if let Err(e) = js_sys::Reflect::set(obj, &JsValue::from_str(key), value) {
        web_sys::console::error_1(&format!("Failed to set JS property '{}': {:?}", key, e).into());
    }
}
```

This function:
- Takes object, key, and value
- Attempts Reflect::set
- On failure: logs error to console and continues (no panic)
- Allows app to continue even if one property fails to set

Note: Most Reflect::set calls succeed in practice, so logging is sufficient for the rare edge cases.
  </action>
  <verify>
Function exists: `grep -c "pub fn js_set" /home/prescott/baras/app/src/utils.rs` returns 1
  </verify>
  <done>js_set helper function added to utils.rs with error logging fallback.</done>
</task>

<task type="auto">
  <name>Task 2: Convert api.rs to use js_set</name>
  <files>app/src/api.rs</files>
  <action>
Update `app/src/api.rs`:

1. Add import at top:
   ```rust
   use crate::utils::js_set;
   ```

2. Replace ALL occurrences of this pattern:
   ```rust
   js_sys::Reflect::set(&obj, &JsValue::from_str("key"), &value).unwrap();
   ```
   With:
   ```rust
   js_set(&obj, "key", &value);
   ```

There are approximately 60 occurrences. Key locations:

- `build_args` function (line ~42)
- `cleanup_logs` function (lines ~244-258)
- `pick_directory` function (lines ~331-338)
- `create_encounter_item` function (lines ~384-397)
- `update_encounter_item` function (lines ~411-433)
- `delete_encounter_item` function (lines ~448-471)
- `duplicate_encounter_timer` function (lines ~490-507)
- All `query_*` functions (lines ~654-1200)

Pattern to search: `js_sys::Reflect::set.*\.unwrap\(\)`

For each occurrence:
- Extract the object reference (first arg)
- Extract the key string (second arg, inside JsValue::from_str)
- Extract the value (third arg)
- Replace with `js_set(&obj, "key", &value);`

Also update `build_args` helper function signature if needed - it already handles serialization errors gracefully with unwrap_or(JsValue::NULL).
  </action>
  <verify>
Zero unwraps on Reflect::set: `grep -c "Reflect::set.*unwrap" /home/prescott/baras/app/src/api.rs` returns 0
Compile check: `cd /home/prescott/baras/app && cargo check --target wasm32-unknown-unknown 2>&1 | head -50`
  </verify>
  <done>All js_sys::Reflect::set().unwrap() calls in api.rs replaced with js_set helper. Zero Reflect::set unwraps remain.</done>
</task>

</tasks>

<verification>
1. `grep -c "Reflect::set.*unwrap" /home/prescott/baras/app/src/api.rs` returns 0
2. `grep -c "js_set" /home/prescott/baras/app/src/api.rs` returns ~60 (the converted calls)
3. `cd /home/prescott/baras/app && cargo check --target wasm32-unknown-unknown` compiles
</verification>

<success_criteria>
- js_set helper function exists in utils.rs
- Zero js_sys::Reflect::set().unwrap() calls in api.rs
- All JS property setting uses js_set helper
- App compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-frontend-error-handling/05-02-SUMMARY.md`
</output>
