---
phase: 05-frontend-error-handling
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - app/src/components/charts_panel.rs
  - app/src/components/data_explorer.rs
autonomous: true

must_haves:
  truths:
    - "ECharts option building does not panic"
    - "Float comparisons handle NaN gracefully"
    - "Chart rendering continues even if one property fails"
  artifacts:
    - path: "app/src/components/charts_panel.rs"
      provides: "Charts panel with safe JS interop"
      min_lines: 1000
    - path: "app/src/components/data_explorer.rs"
      provides: "Data explorer with safe JS interop"
      min_lines: 500
  key_links:
    - from: "app/src/components/charts_panel.rs"
      to: "app/src/utils.rs"
      via: "crate::utils::js_set import"
      pattern: "use crate::utils::js_set"
    - from: "app/src/components/data_explorer.rs"
      to: "app/src/utils.rs"
      via: "crate::utils::js_set import"
      pattern: "use crate::utils::js_set"
---

<objective>
Eliminate all js_sys::Reflect::set().unwrap() calls in charts_panel.rs and data_explorer.rs.

Purpose: Removes ~95 potential panic points in ECharts integration code. These files build complex JS objects for chart rendering - any panic would crash the entire frontend.

Output: Both files use js_set helper with zero Reflect::set unwraps.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-frontend-error-handling/05-CONTEXT.md
@.planning/phases/05-frontend-error-handling/05-RESEARCH.md
@app/src/components/charts_panel.rs
@app/src/components/data_explorer.rs
@app/src/utils.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert charts_panel.rs JS interop</name>
  <files>app/src/components/charts_panel.rs</files>
  <action>
Update `app/src/components/charts_panel.rs`:

1. Add import at top with other crate imports:
   ```rust
   use crate::utils::js_set;
   ```

2. Replace ALL occurrences of:
   ```rust
   js_sys::Reflect::set(&obj, &JsValue::from_str("key"), &value).unwrap();
   ```
   With:
   ```rust
   js_set(&obj, "key", &value);
   ```

There are ~68 occurrences, primarily in `build_time_series_option` function.

3. Fix the float comparison on line 98:
   ```rust
   // Before:
   windows.sort_by(|a, b| a.start_secs.partial_cmp(&b.start_secs).unwrap());

   // After:
   windows.sort_by(|a, b| {
       a.start_secs.partial_cmp(&b.start_secs).unwrap_or(std::cmp::Ordering::Equal)
   });
   ```

This handles NaN values gracefully by treating them as equal (stable sort order).

Key locations for Reflect::set:
- Title object building (~lines 126-153)
- Grid object (~lines 156-166)
- X-axis configuration (~lines 175-213)
- Y-axis configuration (~lines 216-294)
- Tooltip (~lines 297-304)
- Series data (~lines 341-553)
- Mark areas for effect windows (~lines 407-488)
  </action>
  <verify>
Zero unwraps on Reflect::set: `grep -c "Reflect::set.*unwrap" /home/prescott/baras/app/src/components/charts_panel.rs` returns 0
Zero unwraps on partial_cmp: `grep -c "partial_cmp.*unwrap\(\)" /home/prescott/baras/app/src/components/charts_panel.rs` returns 0
Compile check: `cd /home/prescott/baras/app && cargo check --target wasm32-unknown-unknown 2>&1 | head -50`
  </verify>
  <done>All js_sys::Reflect::set().unwrap() and partial_cmp().unwrap() calls in charts_panel.rs replaced with safe alternatives.</done>
</task>

<task type="auto">
  <name>Task 2: Convert data_explorer.rs JS interop</name>
  <files>app/src/components/data_explorer.rs</files>
  <action>
Update `app/src/components/data_explorer.rs`:

1. Add import at top with other crate imports:
   ```rust
   use crate::utils::js_set;
   ```

2. Replace ALL occurrences of:
   ```rust
   js_sys::Reflect::set(&obj, &JsValue::from_str("key"), &value).unwrap();
   ```
   With:
   ```rust
   js_set(&obj, "key", &value);
   ```

There are ~33 occurrences, primarily in `build_donut_option` function.

Key locations:
- `build_donut_option` function - builds ECharts donut chart config
- Title, legend, series configuration objects
- Data array construction

Search pattern: `js_sys::Reflect::set.*\.unwrap\(\)`
  </action>
  <verify>
Zero unwraps on Reflect::set: `grep -c "Reflect::set.*unwrap" /home/prescott/baras/app/src/components/data_explorer.rs` returns 0
Compile check: `cd /home/prescott/baras/app && cargo check --target wasm32-unknown-unknown 2>&1 | head -50`
  </verify>
  <done>All js_sys::Reflect::set().unwrap() calls in data_explorer.rs replaced with js_set helper.</done>
</task>

</tasks>

<verification>
1. `grep -c "Reflect::set.*unwrap" /home/prescott/baras/app/src/components/charts_panel.rs` returns 0
2. `grep -c "Reflect::set.*unwrap" /home/prescott/baras/app/src/components/data_explorer.rs` returns 0
3. `grep -c "partial_cmp.*unwrap\(\)" /home/prescott/baras/app/src/components/charts_panel.rs` returns 0
4. `cd /home/prescott/baras/app && cargo check --target wasm32-unknown-unknown` compiles
</verification>

<success_criteria>
- Zero js_sys::Reflect::set().unwrap() calls in charts_panel.rs
- Zero js_sys::Reflect::set().unwrap() calls in data_explorer.rs
- Zero partial_cmp().unwrap() calls in charts_panel.rs
- Both files use js_set helper
- App compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-frontend-error-handling/05-03-SUMMARY.md`
</output>
