---
phase: 03-core-error-handling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - core/src/effects/tracker.rs
  - core/src/timers/signal_handlers.rs
  - core/src/storage/writer.rs
  - core/src/encounter/shielding.rs
autonomous: true

must_haves:
  truths:
    - "effects/tracker.rs has zero unwrap calls"
    - "timers/signal_handlers.rs has zero unwrap calls"
    - "storage/writer.rs has zero unwrap calls"
    - "encounter/shielding.rs has zero unwrap calls"
  artifacts:
    - path: "core/src/effects/tracker.rs"
      provides: "Refactored get_entities helper without unwrap"
      contains: "let Some(enc) = encounter else"
    - path: "core/src/timers/signal_handlers.rs"
      provides: "Refactored get_entities helper without unwrap"
      contains: "let Some(enc) = encounter else"
    - path: "core/src/storage/writer.rs"
      provides: "Safe array access with unwrap_or"
      contains: "unwrap_or(0)"
    - path: "core/src/encounter/shielding.rs"
      provides: "Iterator filter pattern without unwrap"
      contains: "filter_map"
  key_links:
    - from: "core/src/effects/tracker.rs"
      to: "get_entities function"
      via: "early return pattern"
      pattern: "let Some\\(enc\\) = encounter else"
---

<objective>
Refactor simple helper functions to eliminate unwrap calls without changing signatures.

Purpose: Remove 4 unwrap calls in helper functions using idiomatic Rust patterns (early return, unwrap_or, filter_map). These are self-contained refactors with no API changes.

Output: Four files with zero unwrap calls, all tests passing.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-error-handling/03-RESEARCH.md

@core/src/effects/tracker.rs
@core/src/timers/signal_handlers.rs
@core/src/storage/writer.rs
@core/src/encounter/shielding.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor get_entities helpers in effects and timers</name>
  <files>core/src/effects/tracker.rs, core/src/timers/signal_handlers.rs</files>
  <action>
Both files have identical `get_entities` helper functions with an unwrap after checking:

```rust
// Current pattern (line 24-34 in effects/tracker.rs, line 16-26 in timers/signal_handlers.rs)
fn get_entities(encounter: Option<&CombatEncounter>) -> &[EntityDefinition] {
    static EMPTY: &[EntityDefinition] = &[];
    encounter
        .and_then(|e| e.active_boss_idx())
        .map(|idx| {
            encounter.unwrap().boss_definitions()[idx]  // <-- unwrap here
                .entities
                .as_slice()
        })
        .unwrap_or(EMPTY)
}
```

Replace with early return pattern in BOTH files:

```rust
fn get_entities(encounter: Option<&CombatEncounter>) -> &[EntityDefinition] {
    static EMPTY: &[EntityDefinition] = &[];
    let Some(enc) = encounter else { return EMPTY; };
    let Some(idx) = enc.active_boss_idx() else { return EMPTY; };
    enc.boss_definitions()[idx].entities.as_slice()
}
```

This eliminates both unwrap calls by using the simplified if-let pattern.
  </action>
  <verify>
Run: `grep -n "\.unwrap()" core/src/effects/tracker.rs core/src/timers/signal_handlers.rs`
Expected: No matches
  </verify>
  <done>Both get_entities helpers use early return pattern with zero unwrap calls</done>
</task>

<task type="auto">
  <name>Task 2: Fix storage writer and shielding safe operations</name>
  <files>core/src/storage/writer.rs, core/src/encounter/shielding.rs</files>
  <action>
**storage/writer.rs line 550:**

Current code accesses `.last().unwrap()` on an array that always has at least one element:
```rust
offsets.push(0);  // Always has at least one element
// ... later in loop:
offsets.push(*offsets.last().unwrap());
```

Replace with safe default:
```rust
offsets.push(offsets.last().copied().unwrap_or(0));
```

**encounter/shielding.rs line 90:**

Current code unwraps inside a filter that already verified Some:
```rust
.filter(|e| e.is_shield && e.removed_at.is_some())
.filter(|e| {
    let removed = e.removed_at.unwrap();  // <-- unwrap after is_some check
    // ...
})
```

Replace with filter_map pattern:
```rust
.filter(|e| e.is_shield && e.removed_at.is_some())
.filter_map(|e| {
    let removed = e.removed_at?;
    let delta = timestamp.signed_duration_since(removed).num_milliseconds();
    (0..=RECENTLY_CLOSED_GRACE_MS).contains(&delta).then_some(e)
})
```

Or more simply, combine the filters:
```rust
.filter(|e| e.is_shield)
.filter(|e| {
    e.removed_at
        .map(|removed| {
            let delta = timestamp.signed_duration_since(removed).num_milliseconds();
            (0..=RECENTLY_CLOSED_GRACE_MS).contains(&delta)
        })
        .unwrap_or(false)
})
```
  </action>
  <verify>
Run: `grep -n "\.unwrap()" core/src/storage/writer.rs core/src/encounter/shielding.rs`
Expected: No matches
Run: `cargo test -p core --lib`
Expected: All tests pass
  </verify>
  <done>storage/writer.rs uses unwrap_or(0), shielding.rs uses Option combinators instead of unwrap</done>
</task>

</tasks>

<verification>
```bash
# Verify no unwrap calls remain in modified files
grep -n "\.unwrap()" core/src/effects/tracker.rs core/src/timers/signal_handlers.rs core/src/storage/writer.rs core/src/encounter/shielding.rs

# Should return empty (no matches)

# Run tests to ensure no regressions
cargo test -p core --lib
```
</verification>

<success_criteria>
1. Zero unwrap calls in effects/tracker.rs
2. Zero unwrap calls in timers/signal_handlers.rs
3. Zero unwrap calls in storage/writer.rs
4. Zero unwrap calls in encounter/shielding.rs
5. All core tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-error-handling/03-01-SUMMARY.md`
</output>
