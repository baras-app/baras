---
phase: 07-clone-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - core/src/signal_processor/phase.rs
  - core/src/signal_processor/signal.rs
autonomous: true

must_haves:
  truths:
    - "Phase transition detection works correctly for HP, ability, entity, and time triggers"
    - "PhaseChanged signals contain correct boss_id, old_phase, new_phase values"
    - "Counters reset correctly on phase transitions"
  artifacts:
    - path: "core/src/signal_processor/phase.rs"
      provides: "Phase transition logic with reduced clones"
      contains: "check_hp_phase_transitions"
    - path: "core/src/signal_processor/signal.rs"
      provides: "GameSignal enum potentially with borrowed strings"
      contains: "PhaseChanged"
  key_links:
    - from: "core/src/signal_processor/phase.rs"
      to: "GameSignal::PhaseChanged"
      via: "signal construction"
      pattern: "GameSignal::PhaseChanged"
---

<objective>
Reduce unnecessary clones in phase.rs by restructuring borrow checker workarounds and optimizing signal construction.

Purpose: phase.rs has 35 clones, mostly from:
1. Cloning data before loops to avoid borrow conflicts (immutable borrow then mutable borrow)
2. Cloning String fields when constructing PhaseChanged signals

Output: phase.rs with ~50% fewer clones (target: 17 or fewer), all tests passing
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@core/src/signal_processor/phase.rs
@core/src/signal_processor/signal.rs
@core/src/encounter/combat.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Restructure borrow checker workarounds in phase transition functions</name>
  <files>core/src/signal_processor/phase.rs</files>
  <action>
The four phase transition functions (check_hp_phase_transitions, check_ability_phase_transitions, check_entity_phase_transitions, check_time_phase_transitions) all follow the same problematic pattern:

1. Clone `current_phase`, `previous_phase`, `counter_defs`, `phases`, `entities` before the loop
2. Iterate through phases
3. When a match is found, re-borrow `cache.current_encounter_mut()` for mutation

**Restructure to eliminate unnecessary clones:**

For the loop phase check patterns, instead of:
```rust
let current_phase = enc.current_phase.clone();
let previous_phase = enc.previous_phase.clone();
for phase in &def.phases {
    if current_phase.as_ref() == Some(&phase.id) { continue; }
    // ...
}
```

Use reference comparison without cloning:
```rust
for phase in &def.phases {
    if enc.current_phase.as_ref() == Some(&phase.id) { continue; }
    // preceded_by check can use as_ref() chains
    if let Some(ref required) = phase.preceded_by {
        let last_phase = enc.current_phase.as_ref().or(enc.previous_phase.as_ref());
        if last_phase != Some(required) { continue; }
    }
    // ...
}
```

For counter_defs and phases that need to survive the mutable borrow:
- Store indices or collect minimal data needed (just phase.id, phase.resets_counters) before the mutable call
- Or restructure so the immutable access happens after finding the matching phase

**Specific changes for each function:**

1. `check_hp_phase_transitions`: Remove clones on lines 37-39, use references in the loop. Only clone when constructing the signal (lines 67-70).

2. `check_ability_phase_transitions`: Same pattern - remove clones on lines 106-108, use references.

3. `check_entity_phase_transitions`: This clones `phases` into a Vec (line 172) and `entities` (line 175). Since we only need to find one matching phase, use `def.phases.iter()` directly. Clone only what's needed for the signal after finding a match.

4. `check_time_phase_transitions`: Same pattern as check_entity_phase_transitions.

**Keep necessary clones:**
- Signal field clones (`old_phase`, `new_phase`, `boss_id`) are required because GameSignal owns these strings
- `resets` clone may be required if `reset_counters_to_initial` needs ownership

Target: Remove ~18 clones from the loop setup patterns, keeping ~17 necessary signal construction clones.
  </action>
  <verify>
Run `cargo build -p core` to verify compilation.
Run `cargo clippy -p core -- -D warnings` to verify no new warnings.
Count clones: `grep -c '\.clone()' core/src/signal_processor/phase.rs` should show reduction.
  </verify>
  <done>
phase.rs compiles clean, clone count reduced from 35 to ~17 or fewer.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify phase transition behavior with existing tests</name>
  <files>core/src/signal_processor/phase.rs</files>
  <action>
Run the core crate tests to verify phase transitions still work correctly:

```bash
cargo test -p core
```

If any tests fail related to phase transitions, debug and fix. The restructuring should be purely mechanical and not change behavior.

Also run the full test suite to catch any regressions:
```bash
cargo test --workspace
```

**Expected test coverage:**
- Phase transitions trigger on correct HP thresholds
- Phase transitions trigger on correct abilities/effects
- Phase transitions trigger on entity events (NpcFirstSeen, EntityDeath)
- Phase transitions respect preceded_by constraints
- Counter resets work on phase change
  </action>
  <verify>
`cargo test -p core` passes all tests.
`cargo test --workspace` passes all tests.
  </verify>
  <done>
All existing tests pass, confirming no behavioral regressions from clone reduction.
  </done>
</task>

</tasks>

<verification>
1. Clone count in phase.rs reduced by 50%+ (from 35 to 17 or fewer)
2. `cargo build -p core` succeeds
3. `cargo clippy -p core -- -D warnings` passes clean
4. `cargo test --workspace` passes
</verification>

<success_criteria>
- phase.rs clone count: 17 or fewer (50%+ reduction from 35)
- All workspace tests pass
- No clippy warnings
</success_criteria>

<output>
After completion, create `.planning/phases/07-clone-cleanup/07-01-SUMMARY.md`
</output>
