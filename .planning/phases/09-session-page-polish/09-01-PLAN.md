---
phase: 09-session-page-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/src-tauri/src/service/mod.rs
  - app/src-tauri/src/service/handler.rs
  - core/src/context/watcher.rs
autonomous: true

must_haves:
  truths:
    - "Backend returns session_end and duration_formatted for historical sessions"
    - "SessionInfo correctly distinguishes live vs historical with populated fields"
    - "Watcher re-reads character from file when log file is empty or short"
  artifacts:
    - path: "app/src-tauri/src/service/mod.rs"
      provides: "SessionInfo with session_end and duration_formatted fields"
      contains: "session_end"
    - path: "app/src-tauri/src/service/handler.rs"
      provides: "session_info() calculates end time and duration for historical sessions"
      contains: "duration_formatted"
  key_links:
    - from: "app/src-tauri/src/service/handler.rs"
      to: "SessionInfo struct"
      via: "session_info() method returning enhanced struct"
      pattern: "session_end.*duration_formatted"
---

<objective>
Backend enhancements to support session page polish

Purpose: Provide the data needed for frontend to display better empty states and historical session information
Output: Enhanced SessionInfo struct with end time/duration fields, fixed watcher behavior for empty files
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-session-page-polish/09-CONTEXT.md
@.planning/phases/09-session-page-polish/09-RESEARCH.md

Key context from RESEARCH.md:
- SessionInfo is defined in app/src-tauri/src/service/mod.rs
- session_info() is implemented in handler.rs lines 206-249
- For historical sessions, session_end can be calculated from last encounter end_time or file modification time
- Watcher needs to re-read character on subsequent polls when file is empty/short
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance SessionInfo struct for historical sessions</name>
  <files>
    - app/src-tauri/src/service/mod.rs
    - app/src-tauri/src/service/handler.rs
    - app/src/types.rs
  </files>
  <action>
Add two new optional fields to SessionInfo struct in both backend (service/mod.rs) and frontend (types.rs):
- `session_end: Option<String>` - End time formatted same as session_start (e.g., "Jan 18, 3:45 PM")
- `duration_formatted: Option<String>` - Human-readable duration (e.g., "47m" or "1h 23m")

In handler.rs session_info() method:
1. For historical sessions (when !is_live_tailing), calculate session_end:
   - Try to get the last encounter's end_time from encounter_history
   - If no encounters, use file modification time as fallback
   - Format as "Jan 18, 3:45 PM" like session_start
2. Calculate duration_formatted:
   - Parse session_start and session_end to compute duration
   - Format as short form: "Xm" for minutes, "Xh Ym" for hours+minutes
3. For live sessions, leave session_end and duration_formatted as None

The is_live_tailing flag is available via self.shared.is_live_tailing.load(Ordering::SeqCst).
  </action>
  <verify>
cargo check -p app --lib
cargo clippy -p app --lib -- -D warnings 2>&1 | head -50
  </verify>
  <done>
SessionInfo struct has session_end and duration_formatted fields populated for historical sessions, None for live sessions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix watcher character re-read for empty files</name>
  <files>
    - core/src/context/watcher.rs
  </files>
  <action>
Investigate and fix the watcher bug described in CONTEXT.md:
- Currently watcher only reads file once and caches character
- Empty files don't trigger re-read, causing stale character display
- Expected: Re-read empty/short files on subsequent polls until character data found

Trace from DirectoryWatcher to understand the current flow:
1. Find where character is initially read from log file
2. Identify the caching mechanism that prevents re-read
3. Add logic to re-attempt character extraction when:
   - Current file is empty or very short (< 1KB)
   - Previous character extraction returned None
   - A reasonable interval has passed since last attempt

The fix should NOT constantly re-read valid files with characters - only retry when character data is missing and file is still short/empty.

Use tracing::debug! to log re-read attempts for debugging.
  </action>
  <verify>
cargo check -p baras-core
cargo clippy -p baras-core -- -D warnings 2>&1 | head -50
  </verify>
  <done>
When SWTOR creates a new empty log file, watcher retries character extraction on subsequent polls until character is found or file grows.
  </done>
</task>

</tasks>

<verification>
1. Backend compiles without errors: `cargo check -p app --lib && cargo check -p baras-core`
2. Clippy passes: `cargo clippy -p app --lib -p baras-core -- -D warnings`
3. SessionInfo struct changes are reflected in both backend and frontend types
</verification>

<success_criteria>
- SessionInfo has session_end and duration_formatted fields
- Historical sessions return populated end time and duration
- Live sessions return None for these fields
- Watcher re-reads character from empty/short files on subsequent polls
- All code compiles and passes clippy
</success_criteria>

<output>
After completion, create `.planning/phases/09-session-page-polish/09-01-SUMMARY.md`
</output>
