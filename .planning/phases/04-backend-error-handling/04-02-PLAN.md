---
phase: 04-backend-error-handling
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/src-tauri/src/commands/effects.rs
  - app/src-tauri/src/service/mod.rs
autonomous: true

must_haves:
  truths:
    - "Dev fallback path resolution does not panic"
    - "Missing parent directories fall back to current directory"
    - "Production resource paths work unchanged"
  artifacts:
    - path: "app/src-tauri/src/commands/effects.rs"
      provides: "Safe dev fallback for icons directory"
      contains: "ancestors().nth(2)"
    - path: "app/src-tauri/src/service/mod.rs"
      provides: "Safe dev fallback for sounds and icons directories"
      contains: "ancestors().nth(2)"
  key_links:
    - from: "effects.rs"
      to: "icons directory"
      via: "ancestors().nth(2) fallback"
      pattern: "ancestors.*nth.*2"
    - from: "service/mod.rs"
      to: "sounds directory"
      via: "ancestors().nth(2) fallback"
      pattern: "ancestors.*nth.*2"
---

<objective>
Convert chained .parent().unwrap() calls in dev fallback paths to safe .ancestors().nth() pattern.

Purpose: Prevent panics during development when path traversal fails (edge cases like root directories).
Output: All 8 dev fallback path sites use ancestors() with ultimate fallback to current directory.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-backend-error-handling/04-CONTEXT.md
@.planning/phases/04-backend-error-handling/04-RESEARCH.md

@app/src-tauri/src/commands/effects.rs
@app/src-tauri/src/service/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert effects.rs dev fallback paths</name>
  <files>app/src-tauri/src/commands/effects.rs</files>
  <action>
Replace 4 chained .parent().unwrap() calls with safe ancestors() pattern:

**Lines 493-500** (in get_icon_name_mapping):
```rust
// Before
.unwrap_or_else(|| {
    PathBuf::from(env!("CARGO_MANIFEST_DIR"))
        .parent()
        .unwrap()
        .parent()
        .unwrap()
        .join("icons")
})

// After
.unwrap_or_else(|| {
    PathBuf::from(env!("CARGO_MANIFEST_DIR"))
        .ancestors()
        .nth(2)
        .map(|p| p.to_path_buf())
        .unwrap_or_else(|| PathBuf::from("."))
        .join("icons")
})
```

**Lines 546-553** (in get_icon_preview):
```rust
// Before
.unwrap_or_else(|| {
    PathBuf::from(env!("CARGO_MANIFEST_DIR"))
        .parent()
        .unwrap()
        .parent()
        .unwrap()
        .join("icons")
})

// After
.unwrap_or_else(|| {
    PathBuf::from(env!("CARGO_MANIFEST_DIR"))
        .ancestors()
        .nth(2)
        .map(|p| p.to_path_buf())
        .unwrap_or_else(|| PathBuf::from("."))
        .join("icons")
})
```

Why ancestors().nth(2):
- ancestors() returns iterator: [current, parent, grandparent, ...]
- nth(2) gets grandparent (skips 0=current, 1=parent)
- Same semantics as .parent().unwrap().parent().unwrap()
- Returns None if path is too shallow (instead of panic)

The .map(|p| p.to_path_buf()) is needed because ancestors() yields &Path references.
  </action>
  <verify>
Run: `grep -n "\.unwrap()" app/src-tauri/src/commands/effects.rs` - should return no matches
Run: `grep -c "ancestors" app/src-tauri/src/commands/effects.rs` - should return 2
Run: `cargo check -p baras-app` - should compile without errors
  </verify>
  <done>
Zero .unwrap() calls in effects.rs. Both icon directory fallbacks use ancestors() pattern.
  </done>
</task>

<task type="auto">
  <name>Task 2: Convert service/mod.rs dev fallback paths</name>
  <files>app/src-tauri/src/service/mod.rs</files>
  <action>
Replace 4 chained .parent().unwrap() calls with safe ancestors() pattern:

**Lines 354-362** (bundled_sounds_dir in new()):
```rust
// Before
.unwrap_or_else(|| {
    // Dev fallback: relative to project root
    PathBuf::from(env!("CARGO_MANIFEST_DIR"))
        .parent()
        .unwrap()
        .parent()
        .unwrap()
        .join("core/definitions/sounds")
})

// After
.unwrap_or_else(|| {
    // Dev fallback: relative to project root
    PathBuf::from(env!("CARGO_MANIFEST_DIR"))
        .ancestors()
        .nth(2)
        .map(|p| p.to_path_buf())
        .unwrap_or_else(|| PathBuf::from("."))
        .join("core/definitions/sounds")
})
```

**Lines 467-475** (icons_dir in init_icon_cache):
```rust
// Before
.unwrap_or_else(|| {
    // Dev fallback: relative to project root
    PathBuf::from(env!("CARGO_MANIFEST_DIR"))
        .parent()
        .unwrap()
        .parent()
        .unwrap()
        .join("icons")
})

// After
.unwrap_or_else(|| {
    // Dev fallback: relative to project root
    PathBuf::from(env!("CARGO_MANIFEST_DIR"))
        .ancestors()
        .nth(2)
        .map(|p| p.to_path_buf())
        .unwrap_or_else(|| PathBuf::from("."))
        .join("icons")
})
```

Same pattern as effects.rs - ancestors().nth(2) replaces .parent().unwrap().parent().unwrap().
  </action>
  <verify>
Run: `grep -n "\.unwrap()" app/src-tauri/src/service/mod.rs` - should return no matches
Run: `grep -c "ancestors" app/src-tauri/src/service/mod.rs` - should return 2
Run: `cargo check -p baras-app` - should compile without errors
  </verify>
  <done>
Zero .unwrap() calls in service/mod.rs. Both dev fallback paths use ancestors() pattern.
  </done>
</task>

</tasks>

<verification>
After completion:
- `grep -rn "\.unwrap()" app/src-tauri/src/commands/effects.rs app/src-tauri/src/service/mod.rs` returns nothing
- `cargo check -p baras-app` compiles cleanly
- Code review confirms all 8 sites use ancestors().nth(2) pattern
</verification>

<success_criteria>
- effects.rs has zero .unwrap() calls
- service/mod.rs has zero .unwrap() calls
- All dev fallback paths use ancestors().nth(2) with ultimate fallback to "."
- Code compiles without warnings
</success_criteria>

<output>
After completion, create `.planning/phases/04-backend-error-handling/04-02-SUMMARY.md`
</output>
