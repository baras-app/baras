---
phase: 06-logging-migration
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - overlay/Cargo.toml
  - overlay/src/main.rs
  - overlay/src/icons.rs
  - overlay/src/platform/wayland.rs
  - overlay/src/platform/windows.rs
autonomous: true

must_haves:
  truths:
    - "Zero eprintln! calls in overlay/src/ (excluding win_log! macro definition)"
    - "Overlay binary initializes tracing subscriber for standalone debugging"
    - "Wayland position/rebind operations logged at debug level"
    - "Overlay creation failures logged at error level"
  artifacts:
    - path: "overlay/src/main.rs"
      provides: "Overlay examples with tracing init and structured logging"
      contains: "tracing_subscriber"
  key_links:
    - from: "overlay/src/main.rs"
      to: "tracing_subscriber"
      via: "subscriber init"
      pattern: "tracing_subscriber::fmt\\(\\)"
---

<objective>
Migrate overlay crate eprintln! calls to tracing macros

Purpose: Overlay crate has ~40 eprintln! calls for platform debugging and example output. The binary (main.rs) also needs tracing init for standalone debugging mode.

Output: All production eprintln! in overlay/src/ converted to tracing. Overlay binary initializes a stdout-only tracing subscriber for standalone testing.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-logging-migration/06-CONTEXT.md
@.planning/phases/06-logging-migration/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tracing init to overlay binary and migrate main.rs</name>
  <files>overlay/Cargo.toml, overlay/src/main.rs</files>
  <action>
**Step 1: Add tracing-subscriber dependency to overlay/Cargo.toml**

Add to `[dependencies]` section:
```toml
tracing-subscriber = { workspace = true }
```

This is required before using `tracing_subscriber::fmt()` in the binary.

**Step 2: Add tracing subscriber initialization to overlay binary**

Add at start of main():
```rust
// Initialize tracing for standalone overlay debugging
tracing_subscriber::fmt()
    .with_env_filter(
        tracing_subscriber::EnvFilter::from_default_env()
            .add_directive(tracing::Level::INFO.into())
    )
    .init();
```

**Step 3: Migrate eprintln! calls (~13 calls)**

All `Failed to create X overlay: {}` patterns:
- -> `tracing::error!(error = %e, "Failed to create overlay"); return;`

The example functions have informational println! for user instructions - those can stay as println! since they're meant for terminal output. But error paths should use tracing::error!.

Add `use tracing_subscriber;` at top if not present.
  </action>
  <verify>
`grep "tracing-subscriber" overlay/Cargo.toml` shows the dependency
`grep "eprintln!" overlay/src/main.rs` returns empty
`cargo run -p baras-overlay -- --metric` runs and shows tracing output on errors
  </verify>
  <done>Overlay crate has tracing-subscriber dependency, binary has tracing init, all eprintln! converted</done>
</task>

<task type="auto">
  <name>Task 2: Migrate platform modules eprintln! calls</name>
  <files>overlay/src/platform/wayland.rs, overlay/src/platform/windows.rs, overlay/src/icons.rs</files>
  <action>
Migrate all eprintln! in platform/ and icons.rs to tracing.

**overlay/src/platform/wayland.rs (~18 calls):**
DEBUG level (position/state changes):
- `Rebinding to output {} at ({}, {})...` -> `tracing::debug!(output = %id, x, y, width, height, "Rebinding to output")`
- `Final bound_output_bounds: {:?}` -> `tracing::debug!(?bound_output_bounds, "Final output bounds")`
- `No saved monitor_id, letting compositor choose` -> `tracing::debug!("No monitor_id, compositor chooses output")`
- Position margin calculations -> `tracing::debug!(...)`

ERROR level (failures):
- `Rebind failed: output {} not found` -> `tracing::error!(output = %name, "Rebind failed: output not found")`
- `Rebind failed: no compositor` -> `tracing::error!("Rebind failed: no compositor")`
- `Rebind failed: no layer_shell` -> `tracing::error!("Rebind failed: no layer_shell")`

WARN level (degraded):
- Fallback scenarios -> `tracing::warn!(...)`

**overlay/src/platform/windows.rs:**
The `win_log!` macro definition can stay (it's a macro that wraps eprintln!). Convert the macro to use tracing::debug! instead:
```rust
macro_rules! win_log {
    ($($arg:tt)*) => {
        tracing::debug!($($arg)*);
    };
}
```

**overlay/src/icons.rs (~3 calls):**
- `Found secondary ZIP: {:?}` -> `tracing::debug!(path = ?zip2_path, "Found secondary icon ZIP")`
- `No CSV mapping for ability_id={}` -> `tracing::debug!(ability_id, "No CSV mapping for ability")`
- Error loading icons -> `tracing::warn!(...)`
  </action>
  <verify>
`grep "eprintln!" overlay/src/platform/wayland.rs` returns empty
`grep "eprintln!" overlay/src/platform/windows.rs` returns empty (or only macro def using tracing)
`grep "eprintln!" overlay/src/icons.rs` returns empty
  </verify>
  <done>Zero eprintln! in overlay platform and icons modules</done>
</task>

</tasks>

<verification>
- [ ] `grep -rn "eprintln!" overlay/src/ | grep -v "macro_rules"` returns nothing
- [ ] `cargo check -p baras-overlay` compiles without errors
- [ ] `cargo run -p baras-overlay -- --metric` runs successfully
- [ ] Wayland debug output uses tracing (visible with RUST_LOG=debug)
- [ ] Windows win_log! macro uses tracing::debug!
</verification>

<success_criteria>
1. Overlay crate has tracing-subscriber dependency in Cargo.toml
2. Overlay binary initializes tracing subscriber for standalone mode
3. All eprintln! in main.rs converted to tracing::error! for failures
4. All eprintln! in wayland.rs converted with appropriate levels
5. Windows win_log! macro converted to use tracing::debug!
6. All eprintln! in icons.rs converted
7. Phase success: `grep -rn "eprintln!" --include="*.rs" | grep -v "_tests.rs" | grep -v "validate/"` returns nothing for core/, overlay/, app/src-tauri/
</success_criteria>

<output>
After completion, create `.planning/phases/06-logging-migration/06-04-SUMMARY.md`
</output>
