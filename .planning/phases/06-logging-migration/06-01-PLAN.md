---
phase: 06-logging-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - app/src-tauri/Cargo.toml
  - app/src-tauri/src/logging.rs
  - app/src-tauri/src/lib.rs
autonomous: true

must_haves:
  truths:
    - "App writes logs to ~/.config/baras/baras.log"
    - "Log files rotate when exceeding 10 MB"
    - "DEBUG_LOGGING=1 enables debug output for baras crates"
    - "Default mode logs INFO+ level only"
  artifacts:
    - path: "app/src-tauri/src/logging.rs"
      provides: "Logging initialization with file rotation"
      exports: ["init"]
      min_lines: 50
  key_links:
    - from: "app/src-tauri/src/lib.rs"
      to: "app/src-tauri/src/logging.rs"
      via: "logging::init() call"
      pattern: "let _logging_guard = logging::init"
---

<objective>
Create logging module with file-based output and size-based rotation

Purpose: Users need logs written to files (not stdout) since they won't run the app from terminal. This enables debugging production issues by examining log files.

Output: `logging.rs` module that configures dual-output (file + stdout) with 10 MB size rotation, DEBUG_LOGGING flag support, and proper guard lifetime management.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-logging-migration/06-CONTEXT.md
@.planning/phases/06-logging-migration/06-RESEARCH.md
@.planning/phases/01-logging-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add rolling-file dependency</name>
  <files>Cargo.toml, app/src-tauri/Cargo.toml</files>
  <action>
Add `rolling-file = "0.2"` to workspace dependencies in root Cargo.toml.

Add `rolling-file = { workspace = true }` to app/src-tauri/Cargo.toml dependencies.

This crate provides size-based file rotation (tracing-appender only supports time-based).
  </action>
  <verify>`cargo check -p app` compiles without errors</verify>
  <done>rolling-file dependency available in app crate</done>
</task>

<task type="auto">
  <name>Task 2: Create logging module with file rotation</name>
  <files>app/src-tauri/src/logging.rs, app/src-tauri/src/lib.rs</files>
  <action>
Create `app/src-tauri/src/logging.rs` with:

1. `pub fn init() -> Option<tracing_appender::non_blocking::WorkerGuard>` that:
   - Checks `DEBUG_LOGGING` env var presence (not value, just existence)
   - Gets config dir via `dirs::config_dir()/baras` (ensure dir exists)
   - Creates `BasicRollingFileAppender` with:
     - Path: `{config_dir}/baras.log` (no logs subdirectory â€” single file)
     - Size limit: 10 MB (`10 * 1024 * 1024`)
     - Max files: 1 (keep only latest rotation)
   - Wraps appender in `tracing_appender::non_blocking`
   - Builds layered subscriber with `tracing_subscriber::registry()`:
     - File layer: always INFO+ level, no ANSI, with target
     - Stdout layer: INFO+ default, DEBUG+ for baras crates when DEBUG_LOGGING set
   - Returns the WorkerGuard (caller must hold it for app lifetime)

2. Update `app/src-tauri/src/lib.rs`:
   - Add `mod logging;`
   - Replace current inline tracing init with `let _logging_guard = logging::init();`
   - Keep the guard alive for entire app lifetime (held in run() scope)

Filter directive for DEBUG_LOGGING mode: `"info,app_lib=debug,baras_core=debug,baras_overlay=debug"`

Handle errors gracefully - if log directory creation fails, fall back to stdout-only logging.
  </action>
  <verify>
1. `cargo build -p app`
2. Run app, check `~/.config/baras/baras.log` exists
3. Run with `DEBUG_LOGGING=1`, confirm debug-level messages appear
  </verify>
  <done>App writes structured logs to file with size-based rotation, DEBUG_LOGGING flag works</done>
</task>

</tasks>

<verification>
- [ ] `ls ~/.config/baras/baras.log` shows file exists after app run
- [ ] Log file contains structured output with timestamps and targets
- [ ] `DEBUG_LOGGING=1 cargo run -p app` shows debug-level output
- [ ] Normal run shows only INFO+ level output
</verification>

<success_criteria>
1. Log file created at platform-appropriate config directory
2. File rotation triggers at 10 MB (can verify by checking rolling-file config)
3. DEBUG_LOGGING=1 enables verbose logging for baras crates only
4. WorkerGuard held for app lifetime (no lost logs on shutdown)
</success_criteria>

<output>
After completion, create `.planning/phases/06-logging-migration/06-01-SUMMARY.md`
</output>
